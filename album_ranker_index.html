<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Album Ranker</title>
  <meta name="description" content="Drag-and-drop album ranking with search, export, and local saves by name." />
  <style>
    :root{
      --bg:#0b1220; /* deep navy */
      --panel:#0f172a; /* slate-900 */
      --card:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --muted2:#64748b; /* slate-500 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22c55e; /* green-500 */
      --accent2:#38bdf8; /* sky-400 */
      --danger:#ef4444; /* red-500 */
      --ring:#334155; /* slate-700 */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#0a1020);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji';}
    *{box-sizing:border-box}
    a{color:var(--accent2);text-decoration:none}
    button{cursor:pointer;border:0;border-radius:10px;background:var(--accent2);color:#00131b;padding:10px 14px;font-weight:600;transition:.15s transform ease,.15s box-shadow ease}
    button:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(56,189,248,.25)}
    button.secondary{background:transparent;border:1px solid var(--ring);color:var(--text)}
    button.ghost{background:transparent;color:var(--text);padding:6px 8px;border-radius:8px}
    button.danger{background:var(--danger);color:#fff}
    input,select{background:#0c1324;border:1px solid var(--ring);border-radius:8px;color:var(--text);padding:10px;outline:none}
    input::placeholder{color:#70829b}
    .app{max-width:980px;margin:0 auto;padding:24px}

    header.appbar{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:10px;background:conic-gradient(from 120deg,#38bdf8,#22c55e,#0ea5e9,#22c55e);box-shadow:inset 0 0 0 2px rgba(255,255,255,.08)}
    h1{font-size:22px;margin:0}
    .toolbar{display:flex;align-items:center;gap:10px}
    .count{font-size:14px;color:var(--muted)}
    .saved-badge{font-size:12px;color:#a7f3d0;background:#064e3b;padding:4px 8px;border-radius:999px;display:none}

    .panel{background:linear-gradient(180deg,#0f172a 0%, #0e162a 100%);border:1px solid #0b1225;border-radius:18px;box-shadow:var(--shadow)}
    .panel .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #0b1225}
    .panel .body{padding:12px}

    /* Rank list */
    .list{list-style:none;margin:0;padding:6px}
    .item{display:grid;grid-template-columns:36px 60px 1fr auto auto;gap:12px;align-items:center;padding:8px 10px;margin:8px 0;background:linear-gradient(180deg,#0e172b,#0c1426);border:1px solid #0b1326;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.2);cursor:grab}
    .item.dragging{opacity:.6}
    .handle{width:8px;height:28px;border-radius:3px;background:repeating-linear-gradient( to bottom, #2b3a52 0 3px, #1c273b 3px 6px );justify-self:center}
    .art{width:60px;height:60px;border-radius:10px;background:#0a0f1e center/cover no-repeat;border:1px solid #0b1326}
    .meta{display:flex;flex-direction:column;gap:4px}
    .title{font-weight:700;font-size:16px;line-height:1.1}
    .artist{font-size:13px;color:var(--muted)}
    .rank-input{width:68px;display:flex;align-items:center;gap:6px}
    .rank-input input{width:54px;text-align:center}
    .item .actions{display:flex;gap:8px}
    .remove{opacity:.75}

    .empty{color:var(--muted);text-align:center;padding:36px}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.6);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.active{display:flex}
    .sheet{width:min(860px,92vw);max-height:90vh;background:linear-gradient(180deg,#0e1628,#0b1222);border:1px solid #0b1225;border-radius:18px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .sheet .header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #0b1225;position:sticky;top:0;background:linear-gradient(180deg,#0e1628,#0b1222);z-index:2}
    .sheet .content{padding:16px;overflow:auto;max-height:calc(90vh - 56px)}

    /* Add albums dialog */
    .searchbar{display:flex;gap:10px;align-items:center}
    .searchbox{position:relative;flex:1}
    .searchbox input{width:100%;padding-right:34px}
    .searchbox .clear{position:absolute;right:6px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--muted);font-size:18px;line-height:1;padding:4px 6px;border-radius:6px}
    .searchbox .clear:hover{background:#0b1427;color:var(--text)}
    .searchbar input{flex:1}
    .results{margin-top:12px;max-height:52vh;overflow:auto;border:1px solid #0b1225;border-radius:12px}
    .result{display:grid;grid-template-columns:50px 1fr auto;gap:10px;align-items:center;padding:8px 10px;border-bottom:1px solid #0b1225}
    .result:hover{background:#0b1427}
    .result .thumb{width:50px;height:50px;border-radius:8px;background:#0a0f1e center/cover no-repeat;border:1px solid #0b1225}
    .result .name{font-weight:600}
    .result .sub{font-size:12px;color:var(--muted)}

    .split{display:grid;grid-template-columns:1fr 280px;gap:16px}
    .vsep{border-left:1px dashed #1b2a46}

    .manual{display:flex;flex-direction:column;gap:10px}
    .manual .thumb-preview{width:100%;height:180px;border-radius:12px;background:#0a0f1e center/cover no-repeat;border:1px dashed #1b2a46}
    .muted{color:var(--muted)}

    /* Profile gate */
    .gate{max-width:520px;margin:0 auto}
    .gate h2{margin:0 0 6px 0}

    @media (max-width:800px){
      .split{grid-template-columns:1fr}
      .vsep{display:none}
      .item{grid-template-columns:28px 50px 1fr auto auto}
      .art{width:50px;height:50px}
      .result{grid-template-columns:46px 1fr auto}
      .result .thumb{width:46px;height:46px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="appbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Album Ranker</h1>
          <div class="count" id="count">0 albums</div>
        </div>
      </div>
      <div class="toolbar">
        <span id="savedBadge" class="saved-badge">Saved</span>
        <button id="switchProfile" class="secondary" title="Switch name / profile">Profile</button>
        <button id="addBtn" title="Add album">＋ Add</button>
        <button id="exportBtn" class="secondary" title="Export as .txt">Export TXT</button>
      </div>
    </header>

    <section class="panel">
      <div class="head">
        <div>
          <strong>Ranking</strong>
          <span class="muted" id="profileNameLabel"></span>
        </div>
        <div class="muted">Drag to reorder, or type a number to jump</div>
      </div>
      <div class="body">
        <ul id="list" class="list" aria-live="polite"></ul>
        <div id="empty" class="empty">No albums yet. Click <em>＋ Add</em> to search Apple Music/iTunes or add manually.</div>
      </div>
    </section>

    <p class="muted" style="margin-top:10px;font-size:12px">Tip: Your rankings are saved locally in your browser under a simple name. There is no security. Use Export to share as text.</p>
  </div>

  <!-- Add Albums Modal -->
  <div class="modal" id="addModal" role="dialog" aria-modal="true" aria-labelledby="addModalTitle">
    <div class="sheet">
      <div class="header">
        <strong id="addModalTitle">Add albums</strong>
        <button class="secondary" id="closeAdd">Close</button>
      </div>
      <div class="content split">
        <div>
          <div class="searchbar">
            <button id="backBtn" class="secondary" title="Back to ranking">← Back</button>
            <div class="searchbox">
              <input id="searchInput" type="search" placeholder="Search albums (Apple Music / iTunes)" />
              <button id="clearSearch" class="clear" title="Clear">×</button>
            </div>
            <button id="searchBtn" class="secondary">Search</button>
          </div>
          <div class="muted" style="margin-top:6px;font-size:12px">Smaller art, compact list; <strong>results limited to 12</strong> — refine your search if needed. Powered by iTunes Search API.</div>
          <div id="results" class="results" aria-live="polite"></div>
        </div>
        <div class="vsep"></div>
        <div>
          <h3 style="margin:0 0 10px 0">Manual add</h3>
          <div class="manual">
            <input id="manAlbum" placeholder="Album title" />
            <input id="manArtist" placeholder="Artist name" />
            <input id="manArtUrl" placeholder="Album art URL (optional)" />
            <div id="manPreview" class="thumb-preview"></div>
            <button id="manAddBtn">Add Manual Album</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Gate Modal -->
  <div class="modal" id="gateModal" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="sheet gate">
      <div class="header">
        <strong id="gateTitle">Pick a name for your ranking</strong>
      </div>
      <div class="content">
        <p class="muted">This name is just a key for saving to your browser (localStorage). No accounts, no security. If a name already exists on this device, opening it will show that saved state.</p>
        <form id="gateForm" style="display:flex;gap:10px;align-items:center;margin-top:10px">
          <input id="gateInput" placeholder="e.g. lekh-2025-faves" required minlength="1" />
          <button type="submit">Continue</button>
        </form>
        <div id="gateMsg" class="muted" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <template id="resultRowTpl">
    <div class="result">
      <div class="thumb"></div>
      <div>
        <div class="name"></div>
        <div class="sub"></div>
      </div>
      <div><button class="secondary addOne">Add</button></div>
    </div>
  </template>

  <template id="itemTpl">
    <li class="item" draggable="true">
      <div class="handle" title="Drag to reorder"></div>
      <div class="art"></div>
      <div class="meta">
        <div class="title"></div>
        <div class="artist"></div>
      </div>
      <div class="rank-input" title="Jump to position">
        <input type="number" min="1" step="1" />
      </div>
      <div class="actions">
        <button class="ghost remove" title="Remove">🗑</button>
      </div>
    </li>
  </template>

  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const listEl = $('#list');
    const emptyEl = $('#empty');
    const countEl = $('#count');
    const savedBadge = $('#savedBadge');
    const profileNameLabel = $('#profileNameLabel');

    const addModal = $('#addModal');
    const gateModal = $('#gateModal');

    const state = {
      profile: null,
      items: [], // {id, album, artist, art, sourceUrl}
      dragIndex: null,
      saveTimer: null,
    };

    // ----- Local Storage -----
    const keyFor = (name) => `albumRanker:v1:${name}`;

    function loadProfile(name){
      state.profile = name.trim();
      profileNameLabel.textContent = `· ${state.profile}`;
      const raw = localStorage.getItem(keyFor(name));
      if(raw){
        try{ state.items = JSON.parse(raw).items || []; }
        catch{ state.items = []; }
      } else {
        state.items = [];
      }
      render();
      bumpGateMsg(raw ? `Loaded existing ranking for “${name}”.` : `Created new ranking “${name}”.`);
    }

    function saveNow(){
      if(!state.profile) return;
      const payload = { items: state.items, updatedAt: Date.now() };
      localStorage.setItem(keyFor(state.profile), JSON.stringify(payload));
      showSaved();
    }

    function saveSoon(){
      clearTimeout(state.saveTimer);
      state.saveTimer = setTimeout(saveNow, 400);
    }

    function showSaved(){
      savedBadge.style.display = 'inline-block';
      savedBadge.style.opacity = '1';
      setTimeout(()=>{ savedBadge.style.opacity = '0'; }, 1000);
      setTimeout(()=>{ savedBadge.style.display = 'none'; }, 1400);
    }

    // ----- Rendering -----
    function render(){
      listEl.innerHTML = '';
      if(state.items.length === 0){
        emptyEl.style.display = 'block';
      } else {
        emptyEl.style.display = 'none';
        state.items.forEach((it, idx)=>{
          const li = document.importNode($('#itemTpl').content, true).firstElementChild;
          li.dataset.index = idx;
          li.querySelector('.art').style.backgroundImage = `url('${cssEscape(it.art)}')`;
          li.querySelector('.title').textContent = it.album;
          li.querySelector('.artist').textContent = it.artist;
          const input = li.querySelector('input');
          input.value = idx + 1;
          input.max = state.items.length;

          input.addEventListener('change', (e)=>{
            let n = parseInt(e.target.value, 10);
            if(Number.isNaN(n)) return;
            n = Math.max(1, Math.min(state.items.length, n));
            moveIndex(idx, n-1);
          });

          li.querySelector('.remove').addEventListener('click', ()=>{
            state.items.splice(idx,1);
            render();
            saveSoon();
          });

          makeDraggable(li);
          listEl.appendChild(li);
        });
      }
      countEl.textContent = `${state.items.length} ${state.items.length===1?'album':'albums'}`;
    }

    // ----- Reorder helpers -----
    function moveIndex(from, to){
      if(from === to) return;
      const item = state.items.splice(from,1)[0];
      state.items.splice(to,0,item);
      render();
      saveSoon();
    }

    function makeDraggable(el){
      el.addEventListener('dragstart', (e)=>{
        el.classList.add('dragging');
        state.dragIndex = parseInt(el.dataset.index,10);
        e.dataTransfer.effectAllowed = 'move';
      });
      el.addEventListener('dragend', ()=>{
        el.classList.remove('dragging');
        state.dragIndex = null;
      });
      el.addEventListener('dragover', (e)=>{
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });
      el.addEventListener('drop', (e)=>{
        e.preventDefault();
        const targetIndex = parseInt(el.dataset.index,10);
        if(state.dragIndex===null || Number.isNaN(targetIndex)) return;
        moveIndex(state.dragIndex, targetIndex);
      });
    }

    // ----- iTunes Search -----
    const searchInput = $('#searchInput');
    const searchBtn = $('#searchBtn');
    const resultsEl = $('#results');
    const backBtn = $('#backBtn');
    const clearBtn = $('#clearSearch');

    function updateClearBtn(){ if(clearBtn) clearBtn.style.display = searchInput.value ? 'inline' : 'none'; }
    clearBtn?.addEventListener('click', ()=>{ searchInput.value=''; renderResults([]); updateClearBtn(); searchInput.focus(); });
    backBtn?.addEventListener('click', closeAdd);

    async function searchItunes(term){
      if(!term) return [];
      const url = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=album&limit=12&country=au`;
      const res = await fetch(url);
      if(!res.ok) return [];
      const data = await res.json();
      return data.results || [];
    }

    function highResArt(u){
      if(!u) return placeholderDataURI();
      // Replace size like 100x100 to 512x512 if present
      return u.replace(/\d+x\d+bb\.(jpg|png)/, '512x512bb.$1');
    }

    function renderResults(rows){
      resultsEl.innerHTML='';
      if(!rows.length){
        resultsEl.innerHTML = `<div class="result" style="justify-content:center">No results</div>`;
        return;
      }
      rows.forEach(r=>{
        const row = document.importNode($('#resultRowTpl').content, true).firstElementChild;
        row.querySelector('.thumb').style.backgroundImage = `url('${cssEscape(highResArt(r.artworkUrl100))}')`;
        row.querySelector('.name').textContent = r.collectionName || 'Unknown album';
        const year = (r.releaseDate || '').slice(0,4);
        row.querySelector('.sub').textContent = `${r.artistName || 'Unknown artist'}${year ? ' · ' + year : ''}`;
        row.addEventListener('click', ()=>{
          addAlbum({
            id: `itunes:${r.collectionId}`,
            album: r.collectionName,
            artist: r.artistName,
            art: highResArt(r.artworkUrl100),
            sourceUrl: r.collectionViewUrl || null,
          });
        });
        row.querySelector('.addOne').addEventListener('click', (e)=>{ e.stopPropagation(); row.click();});
        resultsEl.appendChild(row);
      });
    }

    let searchTimer=null;
    searchInput?.addEventListener('input', ()=>{
      updateClearBtn();
      clearTimeout(searchTimer);
      searchTimer=setTimeout(()=> doSearch(), 350);
    });
    searchBtn?.addEventListener('click', ()=> doSearch());

    async function doSearch(){
      const q = searchInput.value.trim();
      if(!q){ renderResults([]); return; }
      resultsEl.innerHTML = `<div class="result" style="justify-content:center">Searching…</div>`;
      try{
        const rows = await searchItunes(q);
        renderResults(rows);
      }catch(err){
        resultsEl.innerHTML = `<div class="result" style="justify-content:center">Search failed</div>`;
        console.error(err);
      }
    }

    function addAlbum(obj){
      state.items.push({
        id: obj.id || `manual:${Date.now()}:${Math.random().toString(36).slice(2,7)}`,
        album: obj.album?.trim() || 'Untitled',
        artist: obj.artist?.trim() || 'Unknown',
        art: obj.art || placeholderDataURI(),
        sourceUrl: obj.sourceUrl || null,
      });
      render();
      saveSoon();
    }

    // ----- Manual Add -----
    const manAlbum = $('#manAlbum');
    const manArtist = $('#manArtist');
    const manArtUrl = $('#manArtUrl');
    const manPreview = $('#manPreview');

    function updateManualPreview(){
      const u = manArtUrl.value.trim();
      manPreview.style.backgroundImage = u ? `url('${cssEscape(u)}')` : 'none';
    }
    manArtUrl.addEventListener('input', updateManualPreview);

    $('#manAddBtn').addEventListener('click', ()=>{
      addAlbum({ album: manAlbum.value, artist: manArtist.value, art: manArtUrl.value });
      manAlbum.value = manArtist.value = manArtUrl.value = '';
      updateManualPreview();
    });

    // ----- Export TXT -----
    function exportTxt(){
      const lines = state.items.map((it, i)=> `${i+1}. ${it.album} — ${it.artist}`);
      const blob = new Blob([lines.join('\n') + '\n'], {type:'text/plain'});
      const a = document.createElement('a');
      const name = state.profile || 'ranking';
      a.href = URL.createObjectURL(blob);
      a.download = `${name}-albums.txt`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    // ----- Modals -----
    function openAdd(){ addModal.classList.add('active'); setTimeout(()=> { updateClearBtn(); searchInput.focus(); }, 50); }
    function closeAdd(){ addModal.classList.remove('active'); }

    function openGate(){ gateModal.classList.add('active'); $('#gateInput').focus(); }
    function closeGate(){ gateModal.classList.remove('active'); }

    $('#addBtn').addEventListener('click', openAdd);
    $('#closeAdd').addEventListener('click', closeAdd);
    $('#exportBtn').addEventListener('click', exportTxt);

    // Close modal by clicking backdrop or pressing Escape
    addModal.addEventListener('click', (e)=>{ if(e.target === addModal) closeAdd(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && addModal.classList.contains('active')) closeAdd(); });

    // Profile switcher
    $('#switchProfile').addEventListener('click', ()=>{
      openGate();
      $('#gateMsg').textContent = 'Switch or create a new name.';
      $('#gateInput').value = state.profile || '';
    });

    $('#gateForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#gateInput').value.trim();
      if(!name) return;
      loadProfile(name);
      closeGate();
    });

    function bumpGateMsg(t){ const el=$('#gateMsg'); el.textContent=t; setTimeout(()=>{ el.textContent=''; }, 2500); }

    // Placeholder image (inline SVG)
    function placeholderDataURI(){
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%230b1220'/><stop offset='100%' stop-color='%23111c37'/></linearGradient></defs><rect width='100%' height='100%' fill='url(%23g)'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%235f7396' font-family='system-ui' font-size='32'>No Art</text></svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }

    function cssEscape(u){
      // Basic escape for quotes in URLs
      return String(u).replace(/'/g, "%27").replace(/\)/g, '%29');
    }

    // Kick off
    openGate();
    render();
  })();
  </script>
</body>
</html>
